{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Document - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .editor-content {
        height: 100%;
        display: flex;
        gap: 1rem;
    }
    
    .text-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    #textArea {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
    }
    
    .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background: white;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .stats-bar {
        background: #e9ecef;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100 py-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-edit text-primary"></i> {{ document.title }}
                    </h4>
                    <p class="text-muted mb-0">
                        <small>
                            Created: {{ document.created_at|date:"M d, Y H:i" }} | 
                            Confidence: {{ document.confidence_score|floatformat:1 }}%
                        </small>
                    </p>
                </div>
                <div>
                    <a href="{% url 'editor:text_document_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="row text-center">
            <div class="col">
                <strong>Words:</strong> <span id="wordCount">{{ document.word_count }}</span>
            </div>
            <div class="col">
                <strong>Characters:</strong> <span id="charCount">{{ document.char_count }}</span>
            </div>
            <div class="col">
                <strong>Lines:</strong> <span id="lineCount">0</span>
            </div>
            <div class="col">
                <strong>Status:</strong> 
                <span class="badge bg-success" id="saveStatus">Saved</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="editor-toolbar">
        <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')">
                    <i class="fas fa-underline"></i>
                </button>
            </div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="undo()">
                    <i class="fas fa-undo"></i> Undo
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="redo()">
                    <i class="fas fa-redo"></i> Redo
                </button>
            </div>

            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-info" onclick="togglePreview()">
                    <i class="fas fa-eye"></i> <span id="previewToggleText">Show Preview</span>
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="saveDocument()">
                    <i class="fas fa-save"></i> Save
                </button>
                <a href="{% url 'editor:export_text_document' document.id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-download"></i> Export
                </a>
            </div>
        </div>
    </div>

    <!-- Editor Content -->
    <div class="editor-content mt-3">
        <div class="text-editor">
            <textarea id="textArea" class="form-control">{{ document.extracted_text }}</textarea>
        </div>
        
        <div class="preview-panel" id="previewPanel" style="display: none;">
            <h5 class="mb-3">Preview</h5>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator" style="display: none;">
        <div class="alert alert-success mb-0 shadow">
            <i class="fas fa-check-circle"></i> Saved successfully
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const textArea = document.getElementById('textArea');
    const previewPanel = document.getElementById('previewPanel');
    const previewContent = document.getElementById('previewContent');
    const wordCount = document.getElementById('wordCount');
    const charCount = document.getElementById('charCount');
    const lineCount = document.getElementById('lineCount');
    const saveStatus = document.getElementById('saveStatus');
    const saveIndicator = document.getElementById('saveIndicator');
    
    let unsavedChanges = false;
    let autoSaveTimeout;

    // Update stats
    function updateStats() {
        const text = textArea.value;
        const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
        const chars = text.length;
        const lines = text.split('\n').length;
        
        wordCount.textContent = words;
        charCount.textContent = chars;
        lineCount.textContent = lines;
    }

    // Text area change handler
    textArea.addEventListener('input', function() {
        updateStats();
        unsavedChanges = true;
        saveStatus.textContent = 'Unsaved';
        saveStatus.className = 'badge bg-warning';
        
        // Auto-save after 2 seconds of no typing
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveDocument, 2000);
        
        // Update preview if visible
        if (previewPanel.style.display !== 'none') {
            updatePreview();
        }
    });

    // Save document
    function saveDocument() {
        const text = textArea.value;
        
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'badge bg-info';
        
        fetch('{% url "editor:save_text_document" document.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                unsavedChanges = false;
                saveStatus.textContent = 'Saved';
                saveStatus.className = 'badge bg-success';
                showSaveIndicator();
            } else {
                saveStatus.textContent = 'Error';
                saveStatus.className = 'badge bg-danger';
                showErrorToast('Failed to save document');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveStatus.textContent = 'Error';
            saveStatus.className = 'badge bg-danger';
            showErrorToast('Error saving document');
        });
    }

    // Show save indicator
    function showSaveIndicator() {
        saveIndicator.style.display = 'block';
        setTimeout(() => {
            saveIndicator.style.display = 'none';
        }, 2000);
    }

    // Toggle preview
    function togglePreview() {
        const toggleText = document.getElementById('previewToggleText');
        if (previewPanel.style.display === 'none') {
            previewPanel.style.display = 'flex';
            toggleText.textContent = 'Hide Preview';
            updatePreview();
        } else {
            previewPanel.style.display = 'none';
            toggleText.textContent = 'Show Preview';
        }
    }

    // Update preview
    function updatePreview() {
        const text = textArea.value;
        // Convert line breaks to <br> and preserve formatting
        const formattedText = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');
        previewContent.innerHTML = formattedText || '<em class="text-muted">No content</em>';
    }

    // Format text (basic formatting)
    function formatText(format) {
        // This is a placeholder - you can implement actual formatting
        alert('Format: ' + format + ' (Feature coming soon)');
    }

    // Undo
    function undo() {
        document.execCommand('undo');
    }

    // Redo
    function redo() {
        document.execCommand('redo');
    }

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (unsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Keyboard shortcuts
    textArea.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveDocument();
        }
    });

    // Initialize
    updateStats();
</script>
{% endblock %}
