{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Document - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .toolbar-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .toolbar-row:last-child {
        margin-bottom: 0;
    }
    
    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: #dee2e6;
        margin: 0 0.25rem;
    }
    
    .editor-content {
        height: 100%;
        display: flex;
        gap: 1rem;
    }
    
    .text-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    #textArea {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
        white-space: pre-wrap;
    }
    
    #textArea.wrap-off {
        white-space: pre;
        overflow-x: auto;
    }
    
    .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background: white;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .stats-bar {
        background: #e9ecef;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .font-size-control {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .font-size-display {
        min-width: 35px;
        text-align: center;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100 py-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-edit text-primary"></i> {{ document.title }}
                    </h4>
                    <p class="text-muted mb-0">
                        <small>
                            Created: {{ document.created_at|date:"M d, Y H:i" }} | 
                            Confidence: {{ document.confidence_score|floatformat:1 }}%
                        </small>
                    </p>
                </div>
                <div>
                    <a href="{% url 'editor:text_document_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="row text-center">
            <div class="col-md-2 col-6">
                <small><strong>Words:</strong></small><br>
                <span id="wordCount">{{ document.word_count }}</span>
            </div>
            <div class="col-md-2 col-6">
                <small><strong>Characters:</strong></small><br>
                <span id="charCount">{{ document.char_count }}</span>
            </div>
            <div class="col-md-2 col-6">
                <small><strong>Lines:</strong></small><br>
                <span id="lineCount">0</span>
            </div>
            <div class="col-md-2 col-6">
                <small><strong>Sentences:</strong></small><br>
                <span id="sentenceCount">0</span>
            </div>
            <div class="col-md-2 col-6">
                <small><strong>Read Time:</strong></small><br>
                <span id="readTime">0 min</span>
            </div>
            <div class="col-md-2 col-6">
                <small><strong>Status:</strong></small><br>
                <span class="badge bg-success" id="saveStatus">Saved</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="editor-toolbar">
        <!-- Row 1: File Operations & Text Transform -->
        <div class="toolbar-row">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-success" onclick="saveDocument()" title="Save (Ctrl+S)">
                    <i class="fas fa-save"></i> Save
                </button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="dropdown" title="Export">
                    <i class="fas fa-download"></i> Export <i class="fas fa-caret-down ms-1"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'editor:export_text_document_docx' document.id %}">
                        <i class="fas fa-file-word text-primary"></i> Word Document (.docx)</a></li>
                    <li><a class="dropdown-item" href="{% url 'editor:export_text_document_pdf' document.id %}">
                        <i class="fas fa-file-pdf text-danger"></i> PDF Document (.pdf)</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDocument('txt')">
                        <i class="fas fa-file-alt"></i> Text File (.txt)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDocument('json')">
                        <i class="fas fa-file-code"></i> JSON (.json)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDocument('html')">
                        <i class="fas fa-file-code"></i> HTML (.html)</a></li>
                </ul>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="transformText('uppercase')" title="UPPERCASE">
                    <i class="fas fa-font"></i> AA
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="transformText('lowercase')" title="lowercase">
                    <i class="fas fa-font"></i> aa
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="transformText('titlecase')" title="Title Case">
                    <i class="fas fa-font"></i> Aa
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="undoAction()" title="Undo (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="redoAction()" title="Redo (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-info" onclick="findReplace()" title="Find & Replace (Ctrl+F)">
                    <i class="fas fa-search"></i> Find
                </button>
                <button type="button" class="btn btn-outline-info" onclick="togglePreview()" title="Toggle Preview">
                    <i class="fas fa-eye"></i> <span id="previewToggleText">Preview</span>
                </button>
            </div>
        </div>
        
        <!-- Row 2: Text Operations & View Controls -->
        <div class="toolbar-row">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="indentText()" title="Indent">
                    <i class="fas fa-indent"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="outdentText()" title="Outdent">
                    <i class="fas fa-outdent"></i>
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="trimLines()" title="Trim Whitespace">
                    <i class="fas fa-eraser"></i> Trim
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="removeDuplicates()" title="Remove Duplicate Lines">
                    <i class="fas fa-compress-alt"></i> Unique
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="sortLines()" title="Sort Lines A-Z">
                    <i class="fas fa-sort-alpha-down"></i> Sort
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="font-size-control">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeFontSize(-1)" title="Decrease Font Size">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="font-size-display" id="fontSizeDisplay">14px</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeFontSize(1)" title="Increase Font Size">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleWordWrap()" title="Toggle Word Wrap" id="wrapBtn">
                <i class="fas fa-align-left"></i> Wrap
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAll()" title="Select All (Ctrl+A)">
                <i class="fas fa-check-double"></i> Select All
            </button>
            
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearText()" title="Clear All Text">
                <i class="fas fa-trash"></i> Clear
            </button>
        </div>
    </div>

    <!-- Editor Content -->
    <div class="editor-content mt-3">
        <div class="text-editor">
            <textarea id="textArea" class="form-control">{{ document.extracted_text }}</textarea>
        </div>
        
        <div class="preview-panel" id="previewPanel" style="display: none;">
            <h5 class="mb-3">Preview</h5>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator" style="display: none;">
        <div class="alert alert-success mb-0 shadow">
            <i class="fas fa-check-circle"></i> Saved successfully
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const textArea = document.getElementById('textArea');
    const previewPanel = document.getElementById('previewPanel');
    const previewContent = document.getElementById('previewContent');
    const wordCount = document.getElementById('wordCount');
    const charCount = document.getElementById('charCount');
    const lineCount = document.getElementById('lineCount');
    const sentenceCount = document.getElementById('sentenceCount');
    const readTime = document.getElementById('readTime');
    const saveStatus = document.getElementById('saveStatus');
    const saveIndicator = document.getElementById('saveIndicator');
    const fontSizeDisplay = document.getElementById('fontSizeDisplay');
    
    let unsavedChanges = false;
    let autoSaveTimeout;
    let currentFontSize = 14;
    let wordWrapEnabled = true;
    let undoStack = [];
    let redoStack = [];
    let maxUndoSteps = 50;

    // Save state for undo/redo
    function saveState() {
        undoStack.push(textArea.value);
        if (undoStack.length > maxUndoSteps) {
            undoStack.shift();
        }
        redoStack = []; // Clear redo stack on new action
    }

    // Update stats
    function updateStats() {
        const text = textArea.value;
        const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
        const chars = text.length;
        const lines = text.split('\n').length;
        
        // Count sentences (approximate)
        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
        
        // Calculate reading time (average 200 words per minute)
        const minutes = Math.ceil(words / 200);
        
        wordCount.textContent = words;
        charCount.textContent = chars;
        lineCount.textContent = lines;
        sentenceCount.textContent = sentences;
        readTime.textContent = minutes + ' min';
    }

    // Text area change handler
    textArea.addEventListener('input', function() {
        updateStats();
        unsavedChanges = true;
        saveStatus.textContent = 'Unsaved';
        saveStatus.className = 'badge bg-warning';
        
        // Auto-save after 2 seconds of no typing
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveDocument, 2000);
        
        // Update preview if visible
        if (previewPanel.style.display !== 'none') {
            updatePreview();
        }
    });

    // Save document
    function saveDocument() {
        const text = textArea.value;
        
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'badge bg-info';
        
        fetch('{% url "editor:save_text_document" document.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                unsavedChanges = false;
                saveStatus.textContent = 'Saved';
                saveStatus.className = 'badge bg-success';
                showSaveIndicator();
            } else {
                saveStatus.textContent = 'Error';
                saveStatus.className = 'badge bg-danger';
                showErrorToast('Failed to save document');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveStatus.textContent = 'Error';
            saveStatus.className = 'badge bg-danger';
            showErrorToast('Error saving document');
        });
    }

    // Show save indicator
    function showSaveIndicator() {
        saveIndicator.style.display = 'block';
        setTimeout(() => {
            saveIndicator.style.display = 'none';
        }, 2000);
    }

    // Toggle preview
    function togglePreview() {
        const toggleText = document.getElementById('previewToggleText');
        if (previewPanel.style.display === 'none') {
            previewPanel.style.display = 'flex';
            toggleText.textContent = 'Hide Preview';
            updatePreview();
        } else {
            previewPanel.style.display = 'none';
            toggleText.textContent = 'Show Preview';
        }
    }

    // Update preview
    function updatePreview() {
        const text = textArea.value;
        // Convert line breaks to <br> and preserve formatting
        const formattedText = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');
        previewContent.innerHTML = formattedText || '<em class="text-muted">No content</em>';
    }

    // Undo/Redo
    function undoAction() {
        if (undoStack.length > 0) {
            redoStack.push(textArea.value);
            textArea.value = undoStack.pop();
            updateStats();
            markUnsaved();
        }
    }

    function redoAction() {
        if (redoStack.length > 0) {
            undoStack.push(textArea.value);
            textArea.value = redoStack.pop();
            updateStats();
            markUnsaved();
        }
    }

    // Text transformation
    function transformText(type) {
        saveState();
        const start = textArea.selectionStart;
        const end = textArea.selectionEnd;
        const selectedText = textArea.value.substring(start, end);
        
        if (selectedText.length === 0) {
            // Transform entire text if nothing selected
            let transformed = textArea.value;
            if (type === 'uppercase') {
                transformed = transformed.toUpperCase();
            } else if (type === 'lowercase') {
                transformed = transformed.toLowerCase();
            } else if (type === 'titlecase') {
                transformed = transformed.replace(/\w\S*/g, txt => 
                    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                );
            }
            textArea.value = transformed;
        } else {
            // Transform selected text
            let transformed = selectedText;
            if (type === 'uppercase') {
                transformed = transformed.toUpperCase();
            } else if (type === 'lowercase') {
                transformed = transformed.toLowerCase();
            } else if (type === 'titlecase') {
                transformed = transformed.replace(/\w\S*/g, txt => 
                    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                );
            }
            textArea.setRangeText(transformed, start, end, 'end');
        }
        updateStats();
        markUnsaved();
    }

    // Indent/Outdent
    function indentText() {
        saveState();
        const start = textArea.selectionStart;
        const end = textArea.selectionEnd;
        const text = textArea.value;
        const lines = text.split('\n');
        const startLine = text.substring(0, start).split('\n').length - 1;
        const endLine = text.substring(0, end).split('\n').length - 1;
        
        for (let i = startLine; i <= endLine; i++) {
            lines[i] = '    ' + lines[i];
        }
        
        textArea.value = lines.join('\n');
        updateStats();
        markUnsaved();
    }

    function outdentText() {
        saveState();
        const start = textArea.selectionStart;
        const end = textArea.selectionEnd;
        const text = textArea.value;
        const lines = text.split('\n');
        const startLine = text.substring(0, start).split('\n').length - 1;
        const endLine = text.substring(0, end).split('\n').length - 1;
        
        for (let i = startLine; i <= endLine; i++) {
            if (lines[i].startsWith('    ')) {
                lines[i] = lines[i].substring(4);
            } else if (lines[i].startsWith('\t')) {
                lines[i] = lines[i].substring(1);
            }
        }
        
        textArea.value = lines.join('\n');
        updateStats();
        markUnsaved();
    }

    // Trim whitespace
    function trimLines() {
        saveState();
        const lines = textArea.value.split('\n');
        const trimmed = lines.map(line => line.trim());
        textArea.value = trimmed.join('\n');
        updateStats();
        markUnsaved();
        showSuccessToast('Whitespace trimmed');
    }

    // Remove duplicate lines
    function removeDuplicates() {
        saveState();
        const lines = textArea.value.split('\n');
        const unique = [...new Set(lines)];
        const removed = lines.length - unique.length;
        textArea.value = unique.join('\n');
        updateStats();
        markUnsaved();
        showSuccessToast(`Removed ${removed} duplicate line(s)`);
    }

    // Sort lines
    function sortLines() {
        saveState();
        const lines = textArea.value.split('\n');
        lines.sort((a, b) => a.localeCompare(b));
        textArea.value = lines.join('\n');
        updateStats();
        markUnsaved();
        showSuccessToast('Lines sorted alphabetically');
    }

    // Font size control
    function changeFontSize(delta) {
        currentFontSize += delta;
        if (currentFontSize < 8) currentFontSize = 8;
        if (currentFontSize > 32) currentFontSize = 32;
        textArea.style.fontSize = currentFontSize + 'px';
        fontSizeDisplay.textContent = currentFontSize + 'px';
    }

    // Word wrap toggle
    function toggleWordWrap() {
        wordWrapEnabled = !wordWrapEnabled;
        if (wordWrapEnabled) {
            textArea.classList.remove('wrap-off');
            document.getElementById('wrapBtn').innerHTML = '<i class="fas fa-align-left"></i> Wrap';
        } else {
            textArea.classList.add('wrap-off');
            document.getElementById('wrapBtn').innerHTML = '<i class="fas fa-align-justify"></i> No Wrap';
        }
    }

    // Select all
    function selectAll() {
        textArea.select();
    }

    // Clear text
    function clearText() {
        if (confirm('Are you sure you want to clear all text? This cannot be undone.')) {
            saveState();
            textArea.value = '';
            updateStats();
            markUnsaved();
        }
    }

    // Find and replace
    function findReplace() {
        const findText = prompt('Find text:');
        if (!findText) return;
        
        const replaceText = prompt('Replace with:');
        if (replaceText === null) return; // Cancelled
        
        saveState();
        const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        const before = textArea.value;
        const after = before.replace(regex, replaceText);
        const count = (before.match(regex) || []).length;
        
        if (count > 0) {
            textArea.value = after;
            updateStats();
            markUnsaved();
            showSuccessToast(`Replaced ${count} occurrence(s)`);
        } else {
            showErrorToast('Text not found');
        }
    }

    // Export document
    function exportDocument(format) {
        event.preventDefault();
        const text = textArea.value;
        const title = '{{ document.title }}'.replace(/\.[^/.]+$/, ''); // Remove extension
        
        let content, mimeType, filename;
        
        if (format === 'txt') {
            content = text;
            mimeType = 'text/plain';
            filename = title + '.txt';
        } else if (format === 'json') {
            const data = {
                title: '{{ document.title }}',
                content: text,
                stats: {
                    words: text.trim().split(/\s+/).filter(w => w.length > 0).length,
                    characters: text.length,
                    lines: text.split('\n').length
                },
                exported: new Date().toISOString()
            };
            content = JSON.stringify(data, null, 2);
            mimeType = 'application/json';
            filename = title + '.json';
        } else if (format === 'html') {
            content = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
        pre { white-space: pre-wrap; background: #f5f5f5; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
</body>
</html>`;
            mimeType = 'text/html';
            filename = title + '.html';
        }
        
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showSuccessToast('Document exported successfully');
    }

    // Helper function to mark as unsaved
    function markUnsaved() {
        unsavedChanges = true;
        saveStatus.textContent = 'Unsaved';
        saveStatus.className = 'badge bg-warning';
    }

    // Toast notifications
    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed shadow';
        toast.style.cssText = 'bottom: 80px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-danger position-fixed shadow';
        toast.style.cssText = 'bottom: 80px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (unsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Keyboard shortcuts
    textArea.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveDocument();
        }
        // Ctrl+F to find
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            findReplace();
        }
        // Ctrl+Z to undo
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undoAction();
        }
        // Ctrl+Y to redo
        if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            redoAction();
        }
        // Tab key handling
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
            updateStats();
            markUnsaved();
        }
    });

    // Initialize
    updateStats();
    saveState(); // Save initial state
</script>
{% endblock %}
